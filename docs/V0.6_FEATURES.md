# ğŸš€ Version 0.6 - Multi-Worker & Performance Improvements

## ğŸ¯ Major Features

### 1. Multi-Worker System

**Run multiple independent workers with separate API credentials!**

#### Benefits:
- âœ… **Avoid Rate Limits**: Distribute channels across multiple Telegram accounts
- âœ… **Higher Throughput**: Process messages in parallel
- âœ… **Fault Isolation**: One worker crash doesn't affect others
- âœ… **Scalability**: Add more workers as your channel count grows

#### Architecture:
```
Worker Manager
â”œâ”€â”€ Worker 1 (API Account 1)
â”‚   â”œâ”€â”€ Session: worker_1_session
â”‚   â””â”€â”€ Channels: 1-10
â”œâ”€â”€ Worker 2 (API Account 2)
â”‚   â”œâ”€â”€ Session: worker_2_session
â”‚   â””â”€â”€ Channels: 11-20
â””â”€â”€ Worker 3 (API Account 3)
    â”œâ”€â”€ Session: worker_3_session
    â””â”€â”€ Channels: 21-30
```

Each worker:
- Has its own Telegram API credentials
- Runs as a separate process
- Forwards messages independently
- Auto-restarts on crash (up to 5 times)

---

### 2. Performance Monitoring

**Track message forwarding delays with precision timing logs!**

#### New Timing Logs:
```
â±ï¸ [TIMING] Message 12345 received at 1637123456.78
â±ï¸ [TIMING] Message 12345 forwarded in 2.34s (processing time: 1.12s)
```

This helps identify:
- Network latency
- API rate limiting
- Media processing bottlenecks
- Queue buildup

---

## ğŸ“‹ Configuration

### Single Worker Mode (Original)
Use `config.json` as before:
```bash
./start.sh
```

### Multi-Worker Mode (New!)
Create `config.json` with workers array:
```json
{
  "admin_bot_token": "YOUR_TOKEN",
  "admin_user_ids": [123456789],
  "workers": [
    {
      "worker_id": "worker_1",
      "api_id": 12345678,
      "api_hash": "abc123...",
      "session_name": "worker_1_session",
      "enabled": true,
      "channel_pairs": [...]
    },
    {
      "worker_id": "worker_2",
      "api_id": 87654321,
      "api_hash": "xyz789...",
      "session_name": "worker_2_session",
      "enabled": true,
      "channel_pairs": [...]
    }
  ]
}
```

Start multi-worker mode:
```bash
./start_multiworker.sh
```

---

## ğŸ® Admin Bot Updates (Coming Soon)

Future updates will add:
- ğŸ”§ Spawn/stop workers from Telegram
- ğŸ“Š View worker status and health
- âš™ï¸ Assign channels to workers
- ğŸ”„ Restart individual workers
- ğŸ“ˆ Real-time performance metrics

---

## ğŸš¦ Worker Status

Workers are monitored every 10 seconds:
- **Alive**: âœ… Worker is running
- **Dead**: âŒ Worker crashed
- **Restarting**: ğŸ”„ Auto-restart in progress

Auto-restart policy:
- Workers auto-restart up to 5 times
- 2-second delay between restarts
- After 5 failures, manual intervention required

---

## ğŸ“ˆ Performance Improvements

### Delay Investigation Results:
- Added comprehensive timing logs
- Identified bottlenecks in message flow
- (Results to be analyzed after real-world testing)

### Optimization Targets:
- Target: <5 seconds for text messages
- Target: <15 seconds for media messages
- Current: 25-30 seconds (investigating)

---

## ğŸ”§ Migration Guide

### From Single Worker to Multi-Worker:

1. **Backup your current config:**
   ```bash
   cp config.json config.single.backup.json
   ```

2. **Create multi-worker config:**
   ```bash
   cp config.multiworker.example.json config.json
   ```

3. **Fill in your API credentials:**
   - Get additional API credentials from https://my.telegram.org
   - Each worker needs unique api_id and api_hash
   - Use different session names for each worker

4. **Distribute your channels:**
   - Divide channel pairs across workers
   - Balance load evenly
   - Consider rate limits per account

5. **Start multi-worker manager:**
   ```bash
   ./start_multiworker.sh
   ```

---

## ğŸ“Š Monitoring

### Log Files:
- `logs/worker_manager.log` - Manager logs
- `logs/forwarder.log` - Combined worker logs
- `worker_*_config.json` - Auto-generated per-worker configs

### Health Checks:
```python
# Get worker status programmatically
manager = WorkerManager()
status = manager.get_status()
print(status)
```

Output:
```python
{
  'worker_1': {
    'alive': True,
    'pid': 12345,
    'uptime': 3600.5,
    'restart_count': 0
  },
  'worker_2': {
    'alive': True,
    'pid': 12346,
    'uptime': 3598.2,
    'restart_count': 1
  }
}
```

---

## âš ï¸ Important Notes

### Rate Limits:
- Telegram limits: ~20 messages/minute per account
- Multi-worker bypasses this by using multiple accounts
- Each worker is independent from rate limit perspective

### Session Files:
- Each worker creates its own `.session` file
- Don't share session files between workers
- Keep session files secure (contains auth tokens)

### Process Management:
- Worker Manager runs as parent process
- Each worker is a child process
- Ctrl+C stops all workers gracefully
- Individual worker crashes don't affect others

---

## ğŸ› Troubleshooting

### Worker Won't Start:
```
âŒ Worker worker_1 failed to start
```

**Solutions:**
1. Check API credentials (api_id, api_hash)
2. Verify session file permissions
3. Check if account is banned/restricted
4. Review logs: `logs/worker_manager.log`

### Worker Keeps Restarting:
```
âš ï¸ Worker worker_2 is dead (restarts: 4)
```

**Solutions:**
1. Check for FloodWaitError in logs
2. Verify channel access permissions
3. Reduce channel count for this worker
4. Check network connectivity

### High CPU Usage:
**Solutions:**
1. Reduce worker count
2. Increase sleep intervals
3. Check for message loops
4. Monitor with `htop` or `top`

---

## ğŸ“š Technical Details

### Process Architecture:
```
Main Process (worker_manager.py)
â”œâ”€â”€ Monitor Thread (10s interval)
â”œâ”€â”€ Worker 1 Process
â”‚   â””â”€â”€ TelegramForwarder instance
â”œâ”€â”€ Worker 2 Process
â”‚   â””â”€â”€ TelegramForwarder instance
â””â”€â”€ Worker 3 Process
    â””â”€â”€ TelegramForwarder instance
```

### Inter-Process Communication:
- Workers are fully independent
- No shared memory or IPC
- Each worker has its own config file
- Manager monitors via process.is_alive()

### Graceful Shutdown:
1. SIGINT/SIGTERM received
2. Manager stops monitoring
3. Workers receive terminate signal
4. 10-second grace period
5. Force kill if needed

---

## ğŸ‰ Benefits Summary

| Feature | Single Worker | Multi-Worker |
|---------|--------------|--------------|
| **Rate Limit** | 20 msg/min | 20Ã—N msg/min |
| **Fault Tolerance** | None | Isolated |
| **Scalability** | Limited | High |
| **Setup Complexity** | Low | Medium |
| **API Accounts Needed** | 1 | N |

---

## ğŸ”® Future Enhancements

Planned for v0.7+:
- [ ] Web dashboard for worker management
- [ ] Real-time performance graphs
- [ ] Automatic load balancing
- [ ] Hot-reload worker config
- [ ] Worker health API endpoint
- [ ] Telegram bot commands for worker control

---

## ğŸ“ Changelog

### v0.6.0 (Current - In Progress)
- âœ… Multi-worker architecture
- âœ… Worker manager with auto-restart
- âœ… Per-worker configuration
- âœ… Performance timing logs
- âœ… Multi-worker startup script
- â³ Admin bot worker control (coming soon)
- â³ Delay investigation results (pending testing)

---

**Status: ğŸš§ Development Branch (v0.6)**
**Ready for Testing: After admin bot updates complete**
**Estimated Merge to Main: TBD**

